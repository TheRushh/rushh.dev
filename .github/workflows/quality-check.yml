name: Code Quality Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  quality:
    name: Quality & Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript compilation check
        run: npx tsc --noEmit

      - name: Run ESLint
        run: npm run lint

      - name: Check code formatting
        run: npm run format:check

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Generate quality report
        id: quality
        run: |
          # Run quality check and capture output
          npm run quality > quality-output.txt 2>&1 || true

          # Extract quality scores from coverage-summary.json
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)

            echo "lines=$LINES" >> $GITHUB_OUTPUT
            echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Comment PR with quality report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read coverage summary
            let coverageTable = '';
            try {
              const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = summary.total;

              const getIcon = (pct) => {
                if (pct >= 90) return 'üü¢';
                if (pct >= 80) return 'üü°';
                return 'üî¥';
              };

              coverageTable = `
              | Metric | Coverage | Status |
              |--------|----------|--------|
              | Lines | ${total.lines.pct.toFixed(1)}% | ${getIcon(total.lines.pct)} |
              | Statements | ${total.statements.pct.toFixed(1)}% | ${getIcon(total.statements.pct)} |
              | Functions | ${total.functions.pct.toFixed(1)}% | ${getIcon(total.functions.pct)} |
              | Branches | ${total.branches.pct.toFixed(1)}% | ${getIcon(total.branches.pct)} |
              `;

              const avgCoverage = (total.lines.pct + total.statements.pct + total.functions.pct + total.branches.pct) / 4;
              const overallScore = avgCoverage;
              const overallIcon = getIcon(overallScore);

              const body = `## ${overallIcon} Code Quality Report

              ### Overall Quality Score: **${overallScore.toFixed(1)}/100**

              ### Test Coverage
              ${coverageTable}

              ### Quality Checks
              - ‚úÖ TypeScript compilation passed
              - ‚úÖ ESLint checks passed
              - ‚úÖ Code formatting verified
              - ‚úÖ All tests passed (${summary.total.lines.covered} statements covered)

              ### Coverage Report
              üìä [View detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

              ---
              *Quality checks completed successfully! üéâ*`;

              // Find existing comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('Code Quality Report')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            } catch (error) {
              console.error('Error reading coverage summary:', error);

              // Post error comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '## ‚ö†Ô∏è Code Quality Report\n\nUnable to generate coverage report. Please check the workflow logs.'
              });
            }

      - name: Check coverage thresholds
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            THRESHOLD=70

            if (( $(echo "$LINES < $THRESHOLD" | bc -l) )); then
              echo "::error::Coverage ($LINES%) is below threshold ($THRESHOLD%)"
              exit 1
            else
              echo "‚úÖ Coverage ($LINES%) meets threshold ($THRESHOLD%)"
            fi
          fi
